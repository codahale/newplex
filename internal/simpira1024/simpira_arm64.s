//go:build arm64 && !purego

#include "textflag.h"

#define SIMPIRA_STEP(src, dst, zero, inc, t1, t2) \
	EOR R1, R2, R4; \
	VMOV R4, t1.S4; \
	VEOR inc.B16, t1.B16, t1.B16; \
	VORR src.B16, src.B16, t2.B16; \
	AESE zero.B16, t2.B16; \
	AESMC t2.B16, t2.B16; \
	AESE t1.B16, t2.B16; \
	AESMC t2.B16, t2.B16; \
	VEOR t2.B16, dst.B16, dst.B16; \
	ADD $1, R1

// func permute(state *[128]byte)
TEXT Â·permute(SB), NOSPLIT, $0
	MOVD state+0(FP), R0
	
	VLD1 (R0), [V0.B16]
	ADD $16, R0, R3
	VLD1 (R3), [V1.B16]
	ADD $16, R3, R3
	VLD1 (R3), [V2.B16]
	ADD $16, R3, R3
	VLD1 (R3), [V3.B16]
	ADD $16, R3, R3
	VLD1 (R3), [V4.B16]
	ADD $16, R3, R3
	VLD1 (R3), [V5.B16]
	ADD $16, R3, R3
	VLD1 (R3), [V6.B16]
	ADD $16, R3, R3
	VLD1 (R3), [V7.B16]
	
	VEOR V16.B16, V16.B16, V16.B16
	VEOR V17.B16, V17.B16, V17.B16
	MOVW $1, R1 // c
	MOVW $8, R2 // b
	
	MOVD $0x10, R3
	VMOV R3, V17.S[1]
	MOVD $0x20, R3
	VMOV R3, V17.S[2]
	MOVD $0x30, R3
	VMOV R3, V17.S[3]

    SIMPIRA_STEP(V0, V1, V16, V17, V18, V19)
    SIMPIRA_STEP(V2, V3, V16, V17, V18, V19)
    SIMPIRA_STEP(V4, V5, V16, V17, V18, V19)
    SIMPIRA_STEP(V6, V7, V16, V17, V18, V19)

    SIMPIRA_STEP(V1, V6, V16, V17, V18, V19)
    SIMPIRA_STEP(V7, V0, V16, V17, V18, V19)
    SIMPIRA_STEP(V3, V4, V16, V17, V18, V19)
    SIMPIRA_STEP(V5, V2, V16, V17, V18, V19)

    SIMPIRA_STEP(V6, V5, V16, V17, V18, V19)
    SIMPIRA_STEP(V2, V1, V16, V17, V18, V19)
    SIMPIRA_STEP(V0, V3, V16, V17, V18, V19)
    SIMPIRA_STEP(V4, V7, V16, V17, V18, V19)

    SIMPIRA_STEP(V5, V4, V16, V17, V18, V19)
    SIMPIRA_STEP(V7, V6, V16, V17, V18, V19)
    SIMPIRA_STEP(V1, V0, V16, V17, V18, V19)
    SIMPIRA_STEP(V3, V2, V16, V17, V18, V19)

    SIMPIRA_STEP(V4, V3, V16, V17, V18, V19)
    SIMPIRA_STEP(V2, V5, V16, V17, V18, V19)
    SIMPIRA_STEP(V6, V1, V16, V17, V18, V19)
    SIMPIRA_STEP(V0, V7, V16, V17, V18, V19)

    SIMPIRA_STEP(V3, V0, V16, V17, V18, V19)
    SIMPIRA_STEP(V7, V4, V16, V17, V18, V19)
    SIMPIRA_STEP(V5, V6, V16, V17, V18, V19)
    SIMPIRA_STEP(V1, V2, V16, V17, V18, V19)

    SIMPIRA_STEP(V0, V1, V16, V17, V18, V19)
    SIMPIRA_STEP(V2, V3, V16, V17, V18, V19)
    SIMPIRA_STEP(V4, V5, V16, V17, V18, V19)
    SIMPIRA_STEP(V6, V7, V16, V17, V18, V19)

    SIMPIRA_STEP(V1, V6, V16, V17, V18, V19)
    SIMPIRA_STEP(V7, V0, V16, V17, V18, V19)
    SIMPIRA_STEP(V3, V4, V16, V17, V18, V19)
    SIMPIRA_STEP(V5, V2, V16, V17, V18, V19)

    SIMPIRA_STEP(V6, V5, V16, V17, V18, V19)
    SIMPIRA_STEP(V2, V1, V16, V17, V18, V19)
    SIMPIRA_STEP(V0, V3, V16, V17, V18, V19)
    SIMPIRA_STEP(V4, V7, V16, V17, V18, V19)

    SIMPIRA_STEP(V5, V4, V16, V17, V18, V19)
    SIMPIRA_STEP(V7, V6, V16, V17, V18, V19)
    SIMPIRA_STEP(V1, V0, V16, V17, V18, V19)
    SIMPIRA_STEP(V3, V2, V16, V17, V18, V19)

    SIMPIRA_STEP(V4, V3, V16, V17, V18, V19)
    SIMPIRA_STEP(V2, V5, V16, V17, V18, V19)
    SIMPIRA_STEP(V6, V1, V16, V17, V18, V19)
    SIMPIRA_STEP(V0, V7, V16, V17, V18, V19)

    SIMPIRA_STEP(V3, V0, V16, V17, V18, V19)
    SIMPIRA_STEP(V7, V4, V16, V17, V18, V19)
    SIMPIRA_STEP(V5, V6, V16, V17, V18, V19)
    SIMPIRA_STEP(V1, V2, V16, V17, V18, V19)

    SIMPIRA_STEP(V0, V1, V16, V17, V18, V19)
    SIMPIRA_STEP(V2, V3, V16, V17, V18, V19)
    SIMPIRA_STEP(V4, V5, V16, V17, V18, V19)
    SIMPIRA_STEP(V6, V7, V16, V17, V18, V19)

    SIMPIRA_STEP(V1, V6, V16, V17, V18, V19)
    SIMPIRA_STEP(V7, V0, V16, V17, V18, V19)
    SIMPIRA_STEP(V3, V4, V16, V17, V18, V19)
    SIMPIRA_STEP(V5, V2, V16, V17, V18, V19)

    SIMPIRA_STEP(V6, V5, V16, V17, V18, V19)
    SIMPIRA_STEP(V2, V1, V16, V17, V18, V19)
    SIMPIRA_STEP(V0, V3, V16, V17, V18, V19)
    SIMPIRA_STEP(V4, V7, V16, V17, V18, V19)

    SIMPIRA_STEP(V5, V4, V16, V17, V18, V19)
    SIMPIRA_STEP(V7, V6, V16, V17, V18, V19)
    SIMPIRA_STEP(V1, V0, V16, V17, V18, V19)
    SIMPIRA_STEP(V3, V2, V16, V17, V18, V19)

    SIMPIRA_STEP(V4, V3, V16, V17, V18, V19)
    SIMPIRA_STEP(V2, V5, V16, V17, V18, V19)
    SIMPIRA_STEP(V6, V1, V16, V17, V18, V19)
    SIMPIRA_STEP(V0, V7, V16, V17, V18, V19)

    SIMPIRA_STEP(V3, V0, V16, V17, V18, V19)
    SIMPIRA_STEP(V7, V4, V16, V17, V18, V19)
    SIMPIRA_STEP(V5, V6, V16, V17, V18, V19)
    SIMPIRA_STEP(V1, V2, V16, V17, V18, V19)


	MOVD state+0(FP), R0
	VST1 [V0.B16], (R0)
	ADD $16, R0, R3
	VST1 [V1.B16], (R3)
	ADD $16, R3, R3
	VST1 [V2.B16], (R3)
	ADD $16, R3, R3
	VST1 [V3.B16], (R3)
	ADD $16, R3, R3
	VST1 [V4.B16], (R3)
	ADD $16, R3, R3
	VST1 [V5.B16], (R3)
	ADD $16, R3, R3
	VST1 [V6.B16], (R3)
	ADD $16, R3, R3
	VST1 [V7.B16], (R3)
	RET
